@using Spectre.Console
@namespace RazorConsole.Components
@typeparam TItem

<div
    data-scrollbar="true"
    @onkeydown="@KeyDownEventHandler"
    @onfocusin="@OnFocusIn"
    @onfocusout="@OnFocusOut"
    data-track-char="@TrackChar"
    data-thumb-char="@ThumbChar"
    data-track-color="@TrackColorAttribute"
    data-thumb-color="@ThumbColorAttribute"
    data-min-thumb-height="@MinThumbHeight"
/>

@code {
    private bool _isFocused;

    /// <summary>
    /// Character to use for the scrollbar track. Default is │.
    /// </summary>
    [Parameter]
    public char TrackChar { get; set; } = '│';

    /// <summary>
    /// Character to use for the scrollbar thumb. Default is █.
    /// </summary>
    [Parameter]
    public char ThumbChar { get; set; } = '█';

    /// <summary>
    /// Color for the track. Default is <see cref="Color.Gray"/>.
    /// </summary>
    [Parameter]
    public Color TrackColor { get; set; } = Color.Grey;

    /// <summary>
    /// Color for the thumb. Default is <see cref="Color.White"/>.
    /// </summary>
    [Parameter]
    public Color ThumbColor { get; set; } = Color.White;

    /// <summary>
    /// Color for the track when scrollbar is focused. Default is <see cref="Color.Gray74"/>.
    /// </summary>
    [Parameter]
    public Color TrackFocusedColor { get; set; } = Color.Grey74;

    /// <summary>
    /// Color for the track when scrollbar is focused. Default is <see cref="Color.DeepSkyBlue1"/>.
    /// </summary>
    [Parameter]
    public Color ThumbFocusedColor { get; set; } = Color.DeepSkyBlue1;

    /// <summary>
    /// Minimum height for the thumb in characters.
    /// </summary>
    [Parameter]
    public int MinThumbHeight { get; set; } = 1;

    /// <summary>
    /// Scroll context, must be provided from Scrollable.
    /// </summary>
    [Parameter]
    [EditorRequired]
    public required Scrollable<TItem>.ScrollContext<TItem> ScrollContext { get; set; }

    /// <summary>
    /// Callback, that called after focus in event, can be used for any UI changes outside scrollbar.
    /// </summary>
    [Parameter]
    public Action<FocusEventArgs>? OnFocusInCallback { get; set; }

    /// <summary>
    /// Callback, that called after focus out event, can be used for any UI changes outside scrollbar.
    /// </summary>
    [Parameter]
    public Action<FocusEventArgs>? OnFocusOutCallback { get; set; }

    private Func<KeyboardEventArgs, Task> KeyDownEventHandler => ScrollContext.KeyDownEventHandler;

    private string TrackColorAttribute => !_isFocused ? TrackColor.ToHex() : TrackFocusedColor.ToHex();

    private string ThumbColorAttribute => !_isFocused ? ThumbColor.ToHex() : ThumbFocusedColor.ToHex();

    private void OnFocusIn(FocusEventArgs eventArgs)
    {
        _isFocused = true;
        OnFocusInCallback?.Invoke(eventArgs);
    }

    private void OnFocusOut(FocusEventArgs eventArgs)
    {
        _isFocused = false;
        OnFocusOutCallback?.Invoke(eventArgs);
    }
}
