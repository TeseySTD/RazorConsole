@using RazorConsole.Core.Rendering
@using Spectre.Console
@namespace RazorConsole.Components
@implements IDisposable

<div class="spectre-canvas"
     data-canvas="true"
     data-width="@CanvasWidth"
     data-height="@CanvasHeight"
     data-maxwidth="@MaxWidthAttribute"
     data-pixelwidth="@PixelWidth"
     data-scale="@ScaleAttribute"
     data-canvas-data-id="@_dataId"
     data-update-token="@_updateToken"/>

@code {
    /// <summary>
    /// Renders a pixel-based canvas for drawing graphics in the console using Spectre.Console's <see cref="global::Spectre.Console.Canvas"/> renderable.
    /// </summary>
    /// <remarks>
    /// <para>
    /// This component wraps Spectre.Console's Canvas to enable pixel-based drawing of graphics, charts, and pixel art.
    /// Pixels are rendered using console characters with specified colors at (x, y) coordinates.
    /// </para>
    /// <para>
    /// See the <see href="https://spectreconsole.net/widgets/canvas">Spectre.Console Canvas documentation</see> for more information.
    /// </para>
    /// </remarks>

    /// <summary>
    /// The array of pixels to render. Each pixel is defined by (x, y) coordinates and color.
    /// </summary>
    /// <remarks>
    /// Total pixel count must not exceed <c>CanvasWidth * CanvasHeight</c>.
    /// </remarks>
    [Parameter]
    [EditorRequired]
    public (int x, int y, Color color)[] Pixels { get; set; } = [];

    /// <summary>
    /// Width of the canvas in pixels.
    /// </summary>
    [Parameter]
    [EditorRequired]
    public int CanvasWidth { get; set; }

    /// <summary>
    /// Height of the canvas in pixels.
    /// </summary>
    [Parameter]
    [EditorRequired]
    public int CanvasHeight { get; set; }

    /// <summary>
    /// Maximum width of the rendered canvas in console characters. If <c>null</c>, no constraint is applied.
    /// </summary>
    [Parameter]
    public int? MaxWidth { get; set; }

    /// <summary>
    /// Width of each pixel when rendered. Default is 2 characters, creating more square-looking pixels.
    /// </summary>
    [Parameter]
    public int PixelWidth { get; set; } = 2;

    /// <summary>
    /// Whether the canvas should automatically scale to fit the console. Default is <c>false</c>.
    /// </summary>
    [Parameter]
    public bool Scale { get; set; }

    private string? MaxWidthAttribute => MaxWidth?.ToString();
    private string ScaleAttribute => Scale ? "true" : "false";

    private readonly Guid _dataId = Guid.NewGuid();
    private Guid _updateToken; // Token that forces re-render when pixels array has changed
    private (int x, int y, Color color)[]? _lastPixelsReference;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ValidatePixelsLength();
        UpdateRegistry();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        ValidatePixelsLength();

        if (!ReferenceEquals(_lastPixelsReference, Pixels))
        {
            _updateToken = Guid.NewGuid();
            _lastPixelsReference = Pixels;
            UpdateRegistry();
        }
    }

    private void ValidatePixelsLength()
    {
        if (Pixels.Length > CanvasWidth * CanvasHeight)
        {
            throw new ArgumentException(
                $"Canvas pixels count ({Pixels.Length}) must be <= canvas area ({CanvasWidth * CanvasHeight}).");
        }
    }

    private void UpdateRegistry()
    {
        CanvasDataRegistry.Register(_dataId, Pixels);
    }

    public void Dispose()
    {
        CanvasDataRegistry.Unregister(_dataId);
    }
}
