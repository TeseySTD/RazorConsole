name: Deploy Preview

on:
  pull_request_target:
    branches: [main]
    paths:
      - 'website/**'
      - 'src/**'
      - '.github/workflows/pr-preview-artifact.yml'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string

jobs:
  deploy:
    name: Deploy preview
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Get PR number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Wait for CI workflow and artifact
        id: find-ci-run
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr.outputs.pr_number }}';
            const headSha = '${{ github.event.pull_request.head.sha || github.sha }}';
            const expectedArtifactName = `website-preview-${prNumber}-${headSha}`;
            
            let ciRun = null;
            let artifactFound = false;
            const maxWaitTimeMs = 10 * 60 * 1000; // 10 minutes
            const startTime = Date.now();
            
            console.log(`Looking for CI workflow and artifact: ${expectedArtifactName}`);
            console.log(`Will wait up to 10 minutes for the artifact to be created.`);
            
            while (!artifactFound && (Date.now() - startTime) < maxWaitTimeMs) {
              // Check if the artifact exists using repository-level API
              try {
                const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: expectedArtifactName,
                  per_page: 10
                });
                
                // Find artifact that matches our expected name
                const artifact = artifacts.artifacts.find(a => a.name === expectedArtifactName);
                
                if (artifact) {
                  console.log(`âœ“ Found artifact: ${artifact.name} from run ${artifact.workflow_run.id}`);
                  artifactFound = true;
                  ciRun = { id: artifact.workflow_run.id };
                } else {
                  const elapsedMinutes = Math.floor((Date.now() - startTime) / 60000);
                  console.log(`Artifact ${expectedArtifactName} not found. (${elapsedMinutes}/10 minutes elapsed)`);
                  if (artifacts.artifacts.length > 0) {
                    console.log(`Found ${artifacts.artifacts.length} artifacts with similar name.`);
                  }
                  console.log('Waiting for artifact to be created...');
                  await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
                }
              } catch (error) {
                console.log(`Error checking artifacts: ${error.message}. Retrying...`);
                await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
              }
            }
            
            if (!artifactFound) {
              throw new Error(`Timeout: Artifact ${expectedArtifactName} was not found within 10 minutes.`);
            }
            
            core.setOutput('run_id', ciRun.id);
            core.setOutput('artifact_name', expectedArtifactName);

      - name: Download website artifact from CI run
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.find-ci-run.outputs.artifact_name }}
          path: website-dist
          run-id: ${{ steps.find-ci-run.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Cloudflare Pages
        id: deploy
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            pages project list
            pages deploy website-dist --project-name=razorconsole --branch=pr-${{ steps.get-pr.outputs.pr_number }}

      - name: Comment PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.get-pr.outputs.pr_number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const ciRunId = '${{ steps.find-ci-run.outputs.run_id }}';
            
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${ciRunId}`;
            const artifactName = '${{ steps.find-ci-run.outputs.artifact_name }}';
            const deploymentUrl = '${{ steps.deploy.outputs.deployment-url }}';
            const deploymentSuccess = '${{ steps.deploy.outcome }}' === 'success';

            let comment = `## ðŸš€ Preview Deployment

            A preview build has been generated for this PR from CI run [#${ciRunId}](${artifactUrl})!

            **Download the artifact:**
            [${artifactName}](${artifactUrl})

            To view the preview locally:
            1. Download the artifact from the CI workflow run
            2. Extract the ZIP file
            3. Serve the files with a local web server
               (e.g., \`npx serve dist\`)
            `;

            if (deploymentSuccess && deploymentUrl) {
              comment += `

            **ðŸŒ Live Preview URL:** ${deploymentUrl}

            The live preview will be automatically updated when you push new
            commits to this PR.`;
            } else {
              comment += `

            âš ï¸ **Cloudflare deployment failed.** You can still download and test the artifact locally.

            > ðŸ’¡ **Tip:** For automatic live preview deployments, ensure Cloudflare Pages
            > is properly configured with the required secrets.`;
            }

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              (comment.body.includes('Preview Deployment') ||
               comment.body.includes('Preview Build Artifact'))
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: comment
              });
            }
