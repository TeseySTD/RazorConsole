name: Auto-label with version

on:
  pull_request_target:
    types: [closed]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  auto-label-version:
    name: Add version labels
    runs-on: ubuntu-latest
    # Only run when PR is actually merged (not just closed)
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need full history to access the merged PR files
          fetch-depth: 0
          # Checkout the main branch to read the current version
          ref: main

      - name: Read version from nuget-package.props
        id: get-version
        run: |
          # Extract VersionPrefix from nuget-package.props
          VERSION_PREFIX=$(grep -oP '<VersionPrefix>\K[^<]+' nuget/nuget-package.props)
          echo "version_prefix=$VERSION_PREFIX" >> "$GITHUB_OUTPUT"
          echo "Version found: v$VERSION_PREFIX"

      - name: Add PR to version milestone
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VERSION_MILESTONE: v${{ steps.get-version.outputs.version_prefix }}
        run: |
          echo "Adding PR #$PR_NUMBER to milestone '$VERSION_MILESTONE'"
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "Repository: ${{ github.repository }}"
          echo "Head repository: ${{ github.event.pull_request.head.repo.full_name }}"
          
          # Check if this is from a fork
          IS_FORK="false"
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            IS_FORK="true"
            echo "⚠ This PR is from a forked repository, using enhanced permissions handling"
          fi
          
          # Check if milestone exists
          echo "Checking for existing milestone '$VERSION_MILESTONE'..."
          MILESTONE_EXISTS=$(gh api repos/${{ github.repository }}/milestones --jq ".[].title" | grep -x "$VERSION_MILESTONE" || echo "")
          
          if [ -z "$MILESTONE_EXISTS" ]; then
            echo "Creating milestone '$VERSION_MILESTONE'..."
            MILESTONE_DATA=$(gh api repos/${{ github.repository }}/milestones \
              --method POST \
              --field title="$VERSION_MILESTONE" \
              --field description="Issues and PRs included in version $VERSION_MILESTONE" \
              --field state="open" 2>/dev/null || echo "{}")
            
            if echo "$MILESTONE_DATA" | jq -e '.number' >/dev/null 2>&1; then
              echo "✓ Created milestone '$VERSION_MILESTONE'"
            else
              echo "⚠ Failed to create milestone, will try to find existing one"
            fi
          else
            echo "✓ Milestone '$VERSION_MILESTONE' already exists"
          fi
          
          # Get milestone number
          MILESTONE_NUMBER=$(gh api repos/${{ github.repository }}/milestones --jq ".[] | select(.title == \"$VERSION_MILESTONE\") | .number" 2>/dev/null || echo "")
          
          if [ -n "$MILESTONE_NUMBER" ]; then
            echo "Assigning PR #$PR_NUMBER to milestone '$VERSION_MILESTONE' (number: $MILESTONE_NUMBER)"
            
            # Try to assign milestone using GitHub API directly
            ASSIGN_RESULT=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER \
              --method PATCH \
              --field milestone="$MILESTONE_NUMBER" \
              --jq '.milestone.title // "failed"' 2>/dev/null || echo "failed")
            
            if [ "$ASSIGN_RESULT" = "$VERSION_MILESTONE" ]; then
              echo "✓ Successfully assigned PR #$PR_NUMBER to milestone '$VERSION_MILESTONE'"
            else
              echo "⚠ Failed to assign PR to milestone"
              echo "   This may be due to the PR being from a fork or insufficient permissions"
              echo "   The milestone '$VERSION_MILESTONE' exists and can be manually assigned if needed"
            fi
          else
            echo "⚠ Could not find milestone number for '$VERSION_MILESTONE'"
          fi

      - name: Find and assign linked issues to milestone
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VERSION_MILESTONE: v${{ steps.get-version.outputs.version_prefix }}
        run: |
          echo "Looking for issues closed by PR #$PR_NUMBER"
          
          # Get PR details including body and title
          PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body // ""')
          PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title // ""')
          
          # Combine PR title and body for searching
          PR_CONTENT="$PR_TITLE $PR_BODY"
          
          echo "PR Content to analyze:"
          echo "Title: $PR_TITLE"
          echo "Body: $PR_BODY"
          
          # Find issue numbers using common closing keywords
          # Matches patterns like: "fixes #123", "closes #456", "resolves #789", etc.
          ISSUE_NUMBERS=$(echo "$PR_CONTENT" | grep -ioP '(?:fix(?:es|ed)?|close(?:s|d)?|resolve(?:s|d)?|implement(?:s|ed)?)\s+#(\d+)' | grep -oP '#\K\d+' | sort -u || true)
          
          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "No linked issues found in PR content"
          else
            echo "Found linked issues: $ISSUE_NUMBERS"
            
            # Label each found issue
            for ISSUE_NUMBER in $ISSUE_NUMBERS; do
              echo "Processing issue #$ISSUE_NUMBER..."
              
              # Check if issue exists and is closed
              ISSUE_STATE=$(gh issue view "$ISSUE_NUMBER" --json state --jq '.state' 2>/dev/null || echo "not_found")
              
              if [ "$ISSUE_STATE" = "CLOSED" ]; then
                echo "Adding closed issue #$ISSUE_NUMBER to milestone '$VERSION_MILESTONE'..."
                
                # Get milestone number and assign issue to milestone
                MILESTONE_NUMBER=$(gh api repos/${{ github.repository }}/milestones --jq ".[] | select(.title == \"$VERSION_MILESTONE\") | .number" 2>/dev/null || echo "")
                if [ -n "$MILESTONE_NUMBER" ]; then
                  ASSIGN_RESULT=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
                    --method PATCH \
                    --field milestone="$MILESTONE_NUMBER" \
                    --jq '.milestone.title // "failed"' 2>/dev/null || echo "failed")
                  
                  if [ "$ASSIGN_RESULT" = "$VERSION_MILESTONE" ]; then
                    echo "✓ Added issue #$ISSUE_NUMBER to milestone '$VERSION_MILESTONE'"
                  else
                    echo "⚠ Failed to add issue #$ISSUE_NUMBER to milestone"
                  fi
                else
                  echo "⚠ Could not find milestone '$VERSION_MILESTONE'"
                fi
              elif [ "$ISSUE_STATE" = "OPEN" ]; then
                echo "⚠ Issue #$ISSUE_NUMBER is still open, skipping"
              else
                echo "⚠ Issue #$ISSUE_NUMBER not found or inaccessible, skipping"
              fi
            done
          fi

      - name: Summary
        env:
          VERSION_MILESTONE: v${{ steps.get-version.outputs.version_prefix }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "✅ Auto-versioning completed!"
          echo "- Added PR #$PR_NUMBER to milestone '$VERSION_MILESTONE'"
          echo "- Added any linked closed issues to milestone '$VERSION_MILESTONE'"
          echo "- Milestone '$VERSION_MILESTONE' now tracks all PRs and issues for this version"
